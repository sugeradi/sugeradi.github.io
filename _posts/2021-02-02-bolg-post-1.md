---
title: '解决conda install安装包时下载文件失败"CondaHTTPError: HTTP 000 CONNECTION FAILE"的问奖'
date: 2021-02-02
permalink: /posts/2021/02/blog-post-1/
tags:
  - conda install
  - CondaHTTPError
  - 本地安装
---

## 一、Conda安装时下载失败
在Conda中安装pytorch时常常因为下载文件失败，即使用了清华的Conda源还是会失败。

https://link.zhihu.com/?target=https%3A//mirrors.tuna.tsinghua.edu.cn/help/anaconda/

比如：CondaHTTPError: HTTP 000 CONNECTION FAILED
![](https://pic1.zhimg.com/80/v2-ed4776549f1517a796c1bab186d6a2c0_720w.png)

### 而直接将下载好的包放到Conda的pkgs目录中又不生效，Conda还是会重新下载。

## 二、手动下载Conda所需的包本地安装时的问题
网上遇到这种情况的解决方案基本上只有先把文件下载下来，然后本地安装，比如：
![](https://pic3.zhimg.com/80/v2-a4a9b05391fd89cca740d183059cf092_720w.png)

但是这样安装后，重新安装pytorch时，会有一个提示：
![](https://pic3.zhimg.com/80/v2-ab3c5ef375f2c1861b29c00ab583dd42_720w.jpg)

强迫症表示不能忍，能不能出去这个烦人的提示呢？
方法还是有的。

## 三、完美解决本地安装时Conda的警告
本地安装时，Conda认为包是从本地安装的，不是它从指定的网址下载的，即使校验码是对的，也会提示警告。那么可以让Conda在下载时，先检查文件是否存在，如果存在了并且校验码正确，那就不下载了。

1、找到Conda下载文件所使用的函数的文件

首先，可以通过运行下面的命令找出Conda下载文件所使用的函数的文件
```shell
python -c "from conda.gateways.connection import download; print(download.__file__)"
```

在我的电脑上输出是：
```shell
d:\anaconda3\lib\site-packages\conda\gateways\connection\download.py
```

2、找到Conda下载文件所使用的函数

打开这个文件，找到函数download，如下图：
![](https://pic4.zhimg.com/80/v2-e37d03f3a8389d9fda4f48665fdb86ef_720w.jpg)

在函数的最开始处，加入如下的代码：
```python
from ...base.constants import CONDA_TEMP_EXTENSION

tmp_file_path = target_full_path + CONDA_TEMP_EXTENSION
if exists(tmp_file_path):
    print("\n[Download patch] file exists: %s", tmp_file_path)
    
    checksum_ok = True
    
    if sha256 or md5:
        builder = hashlib.new("sha256" if sha256 else "md5")
        checksum = sha256 if sha256 else md5
        
        with open(tmp_file_path, 'rb') as f:
            for chunk in iter(lambda: f.read(4096), b''):
                builder.update(chunk)
        
        actual_checksum = builder.hexdigest()
        if actual_checksum != checksum:
            print("\n[Download patch] cached file checksum mismatch: %s (%s != %s)", 
                checksum_type, actual_checksum, checksum)
        checksum_ok = actual_checksum == checksum
    
    if checksum_ok:
        from ..disk.update import backoff_rename
        backoff_rename(tmp_file_path, target_full_path, True)
        if progress_update_callback:
            progress_update_callback(1.0)
        print("\n[Download patch] using cached file instead of download", target_full_path)
        return
```

修改后的结果如下图：
![](https://pic2.zhimg.com/80/v2-8eb64314f071adc166a4da12439c0441_720w.jpg)

最后保存文件即可。

## 四、测试解决方法是否生效
1、将需要离线安装的包手动下载好后放到conda的pkgs目录下

2、重新执行命令安装，查看输出中是否有包含“[Download patch] using cached file instead of download”等字样。

如果满足上面两条，说明解决方法已经生效。如下图：
![](https://pic1.zhimg.com/80/v2-c79f6415441f2ff60fee8f469cd2e0d8_720w.jpg)
